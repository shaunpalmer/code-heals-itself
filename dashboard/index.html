<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Heals Itself ‚Ä¢ Operator Dashboard</title>
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <header class="top-bar">
      <h1>Operator Dashboard</h1>
      <p class="tagline">Quick controls, live signals, and envelope visibility</p>
    </header>

    <div class="layout">
      <aside class="sidebar" aria-label="primary navigation">
        <h2 class="sidebar-title">Console</h2>
        <nav>
          <ul class="sidebar-nav" id="nav">
            <li><button class="nav-link is-active" data-view-target="overview">Overview</button></li>
            <li><button class="nav-link" data-view-target="envelopes">Envelopes</button></li>
            <li><button class="nav-link" data-view-target="extensions">Extensions</button></li>
            <li><button class="nav-link" data-view-target="heartbeat">Heartbeat</button></li>
            <li><button class="nav-link" data-view-target="testing">Testing</button></li>
            <li><button class="nav-link" data-view-target="settings">‚öôÔ∏è Settings</button></li>
          </ul>
        </nav>
      </aside>

      <main class="content" id="views">
        <section class="view is-active" data-view="overview" aria-label="System overview">
          <section class="grid" aria-label="overview widgets">
            <article class="widget">
              <h2>Healing Success</h2>
              <div class="metric" data-metric="healing-success">--%</div>
              <p class="hint">Rolling 24h acceptance rate</p>
            </article>
            <article class="widget">
              <h2>Breaker Status</h2>
              <div class="metric" data-metric="breaker-status">unknown</div>
              <p class="hint">Trend-aware + envelope breaker</p>
            </article>
            <article class="widget">
              <h2>Pending Reviews</h2>
              <div class="metric" data-metric="pending-reviews">--</div>
              <p class="hint">Awaiting human confirmation</p>
            </article>
          </section>

          <section class="panel" aria-label="control panel">
            <details open>
              <summary>Control Center</summary>
              <form id="control-form" class="control-form">
                <label for="base-url">API base URL</label>
                <input
                  id="base-url"
                  name="base-url"
                  type="url"
                  placeholder="https://localhost:4000/api"
                  autocomplete="off"
                />

                <div class="button-row">
                  <button type="button" data-action="refresh-all">üîÑ Refresh All Data</button>
                  <button type="button" data-action="refresh-metrics">Refresh Metrics</button>
                  <button type="button" data-action="pull-envelope">Fetch Latest Envelope</button>
                  <button type="button" data-action="trigger-heal">Trigger Heal Cycle</button>
                </div>
              </form>
              <p class="hint">
                Commands run against the base URL you provide above. Adjust
                <code>assets/app.js</code> to wire in custom endpoints or authentication.
              </p>
              <output id="control-log" aria-live="polite"></output>
            </details>
          </section>
        </section>

        <section class="view" data-view="envelopes" aria-label="Envelope history">
          <section class="panel">
            <details open>
              <summary>Envelope Timeline</summary>
              <div id="timeline" class="timeline"></div>
            </details>
          </section>

          <section class="panel">
            <details open>
              <summary>Debug Payload</summary>
              <pre id="payload-viewer" class="payload-viewer" tabindex="0">No envelope loaded yet.</pre>
            </details>
          </section>
        </section>

        <section class="view" data-view="extensions" aria-label="Extension toggles">
          <section class="panel">
            <details open>
              <summary>Runtime Extensions</summary>
              <ul id="extensions-list" class="toggle-list" aria-live="polite"></ul>
              <p class="hint">
                Use the toggles to flip observers and post-processing extensions. Requests
                post to <code>/extensions/&lt;id&gt;/enable|disable</code> by default.
              </p>
            </details>
          </section>
        </section>

        <section class="view" data-view="heartbeat" aria-label="Heartbeat controls">
          <section class="panel">
            <details open>
              <summary>Heartbeat Monitor</summary>
              <div class="heartbeat-status">
                <div>
                  <h2 aria-live="polite" data-heartbeat-status>unknown</h2>
                  <p class="hint">Last beat: <span data-heartbeat-timestamp>--</span></p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                  <button type="button" id="heartbeat-ping" class="primary">Send Heartbeat</button>
                  <button type="button" id="restart-server" style="background: var(--warning); border-color: var(--warning);">ÔøΩ Check Server Status</button>
                </div>
              </div>
              <p class="hint">
                Heartbeat calls <code>/status/heartbeat</code> by default. Use "Restart Server" if the backend becomes unresponsive.
              </p>
              <ul id="heartbeat-log" class="heartbeat-log" aria-live="polite"></ul>
            </details>
          </section>
        </section>

        <section class="view" data-view="testing" aria-label="API testing playground">
          <section class="panel">
            <details open>
              <summary>API Testing Playground</summary>
              <div class="testing-controls">
                <div class="form-group">
                  <label for="test-endpoint">Endpoint</label>
                  <select id="test-endpoint" class="test-select">
                    <option value="/status/metrics">GET /status/metrics</option>
                    <option value="/envelopes/latest">GET /envelopes/latest</option>
                    <option value="/status/heartbeat">POST /status/heartbeat</option>
                    <option value="/debug/run">POST /debug/run</option>
                    <option value="/extensions/eslint-enhanced-runner/enable">POST /extensions/.../enable</option>
                    <option value="/extensions/eslint-enhanced-runner/disable">POST /extensions/.../disable</option>
                    <option value="custom">Custom URL...</option>
                  </select>
                </div>

                <div class="form-group" id="custom-url-group" style="display: none;">
                  <label for="custom-endpoint">Custom Endpoint Path</label>
                  <input 
                    id="custom-endpoint" 
                    type="text" 
                    placeholder="/your/custom/path"
                    autocomplete="off"
                  />
                </div>

                <div class="form-group">
                  <label for="test-method">Method</label>
                  <select id="test-method" class="test-select">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                  </select>
                  <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--muted);">
                    üí° <strong>Tip:</strong> If the endpoint label shows POST/PUT/DELETE, make sure to select the matching method above.
                  </p>
                </div>

                <div class="form-group">
                  <label for="test-body">Request Body (JSON)</label>
                  <textarea 
                    id="test-body" 
                    rows="6" 
                    placeholder='{"key": "value"}'
                    class="test-textarea"
                  ></textarea>
                </div>

                <div class="button-row">
                  <button type="button" id="run-test" class="primary">‚ñ∂ Run Test</button>
                  <button type="button" id="clear-test">Clear Results</button>
                </div>
              </div>
              <p class="hint">
                Test API endpoints live. Results appear below with full request/response details.
              </p>
            </details>
          </section>

          <section class="panel">
            <details open>
              <summary>Test Results</summary>
              <div id="test-results" class="test-results">
                <p class="hint">Run a test to see results here...</p>
              </div>
            </details>
          </section>

          <section class="panel">
            <details>
              <summary>Request/Response History</summary>
              <ul id="test-history" class="test-history">
                <li class="hint">No test history yet</li>
              </ul>
            </details>
          </section>
        </section>

        <!-- Settings View -->
        <section class="view" data-view="settings" aria-label="LLM provider settings">
          <h2 class="view-title">ü§ñ LLM Provider Settings</h2>
          <p class="view-subtitle">Configure your LLM provider for AI-powered code healing</p>

          <section class="panel">
            <details open>
              <summary>Provider Configuration</summary>
              <form id="settings-form" class="settings-form">
                <div class="form-group">
                  <label for="provider">Provider</label>
                  <select id="provider" name="provider" class="form-select" required>
                    <option value="lmstudio">üñ•Ô∏è LM Studio (Local)</option>
                    <option value="openai">üîµ OpenAI</option>
                    <option value="anthropic">üü£ Anthropic Claude</option>
                    <option value="ollama">ü¶ô Ollama (Local)</option>
                    <option value="llama">ü¶ô Meta Llama (Local)</option>
                    <option value="azure">‚òÅÔ∏è Azure OpenAI</option>
                    <option value="gemini">üî∑ Google Gemini</option>
                    <option value="custom">‚öôÔ∏è Custom Endpoint</option>
                  </select>
                  <small class="form-hint">Select your LLM provider (local providers don't require API keys)</small>
                </div>

                <div class="form-group" id="api-key-group">
                  <label for="api_key">API Key</label>
                  <div class="input-with-toggle">
                    <input 
                      type="password" 
                      id="api_key" 
                      name="api_key" 
                      class="form-input"
                      placeholder="sk-..." 
                    />
                    <button type="button" id="toggle-api-key" class="btn-toggle-key">üëÅÔ∏è</button>
                  </div>
                  <small class="form-hint">API key will be encrypted and stored securely</small>
                </div>

                <div class="form-group">
                  <label for="base_url">Base URL</label>
                  <input 
                    type="url" 
                    id="base_url" 
                    name="base_url" 
                    class="form-input"
                    placeholder="http://127.0.0.1:1234/v1" 
                    required
                  />
                  <small class="form-hint">API endpoint URL (auto-filled for LM Studio)</small>
                </div>

                <div class="form-group">
                  <label for="model_name">Model</label>
                  <select id="model_name" name="model_name" class="form-select" required>
                    <option value="qwen3-32b">Qwen 3 32B (Premium) - 17.33GB</option>
                    <option value="qwen2-33b">Qwen 2 33B (Premium) - 17.25GB</option>
                    <option value="gpt-oss-20b">GPT-OSS 20B (Premium) - 12.11GB</option>
                    <option value="llama-13b">Llama 13B (Standard) - 7.41GB</option>
                    <option value="llama-12b">Llama 12B (Standard) - 7.48GB</option>
                    <option value="gemma2-9.2b">Gemma2 9.2B (Standard) - 5.76GB</option>
                    <option value="llama-8b">Llama 8B (Fast) - 4.92GB</option>
                    <option value="qwen2-7b">Qwen 2 7B (Fast) - 4.68GB</option>
                    <option value="llama-7b">Llama 7B (Fast) - 4.08GB</option>
                  </select>
                  <small class="form-hint">
                    <span id="model-tier-hint">
                      üíé Premium models offer best quality ‚Ä¢ ‚ö° Standard for balanced performance ‚Ä¢ üöÄ Fast for quick responses
                    </span>
                  </small>
                </div>
              </form>
            </details>
          </section>

          <section class="panel">
            <details open>
              <summary>Model Parameters</summary>
              <div class="settings-form">
                <div class="form-group">
                  <label for="temperature">
                    Temperature: <span id="temperature-value">0.7</span>
                  </label>
                  <input 
                    type="range" 
                    id="temperature" 
                    name="temperature" 
                    min="0" 
                    max="2" 
                    step="0.1" 
                    value="0.7"
                    class="form-range"
                  />
                  <small class="form-hint">Lower = more focused, Higher = more creative (0-2)</small>
                </div>

                <div class="form-group">
                  <label for="max_tokens">Max Tokens</label>
                  <input 
                    type="number" 
                    id="max_tokens" 
                    name="max_tokens" 
                    class="form-input"
                    value="2000" 
                    min="100" 
                    max="100000"
                    step="100"
                  />
                  <small class="form-hint">Maximum tokens to generate (100-100000)</small>
                </div>

                <div class="form-group">
                  <label for="timeout">Request Timeout (seconds)</label>
                  <input 
                    type="number" 
                    id="timeout" 
                    name="timeout" 
                    class="form-input"
                    value="30" 
                    min="5" 
                    max="300"
                  />
                  <small class="form-hint">How long to wait for responses (5-300 seconds)</small>
                </div>
              </div>
            </details>
          </section>

          <section class="panel">
            <details>
              <summary>Advanced Options</summary>
              <div class="settings-form">
                <div class="form-group">
                  <label class="checkbox-label">
                    <input 
                      type="checkbox" 
                      id="keep_alive" 
                      name="keep_alive" 
                      checked
                    />
                    <span>Enable Keep-Alive Pings</span>
                  </label>
                  <small class="form-hint">Periodically ping provider to keep connection alive</small>
                </div>

                <div class="form-group" id="keep-alive-interval-group">
                  <label for="keep_alive_interval">
                    Ping Interval: <span id="keep-alive-interval-value">5</span> minutes
                  </label>
                  <input 
                    type="range" 
                    id="keep_alive_interval" 
                    name="keep_alive_interval" 
                    min="1" 
                    max="30" 
                    step="1" 
                    value="5"
                    class="form-range"
                  />
                  <small class="form-hint">How often to ping (1-30 minutes)</small>
                </div>

                <div class="form-group">
                  <label class="checkbox-label">
                    <input 
                      type="checkbox" 
                      id="enabled" 
                      name="enabled" 
                      checked
                    />
                    <span>Enable LLM Integration</span>
                  </label>
                  <small class="form-hint">Master switch for all LLM functionality</small>
                </div>
              </div>
            </details>
          </section>

          <section class="panel">
            <div class="button-group">
              <button type="button" id="test-connection-btn" class="btn btn-secondary">
                üîç Test Connection
              </button>
              <button type="button" id="fetch-models-btn" class="btn btn-secondary">
                üìã Fetch Models
              </button>
              <button type="button" id="save-settings-btn" class="btn btn-primary">
                üíæ Save Settings
              </button>
            </div>
            <div id="settings-feedback" class="settings-feedback"></div>
          </section>

          <section class="panel">
            <details>
              <summary>Connection Test Results</summary>
              <div id="connection-test-results" class="test-results">
                <p class="hint">Click "Test Connection" to verify your settings...</p>
              </div>
            </details>
          </section>
        </section>
      </main>
    </div>

    <template id="timeline-row">
      <article class="timeline-row">
        <header>
          <strong data-field="summary">Envelope</strong>
          <span data-field="status">status</span>
        </header>
        <dl>
          <div>
            <dt>Updated</dt>
            <dd data-field="timestamp">--</dd>
          </div>
          <div>
            <dt>Confidence</dt>
            <dd data-field="confidence">--</dd>
          </div>
          <div>
            <dt>Breaker</dt>
            <dd data-field="breaker">--</dd>
          </div>
        </dl>
      </article>
    </template>

    <template id="extension-item">
      <li class="toggle-item">
        <div class="toggle-meta">
          <h3 data-field="name">Extension</h3>
          <p data-field="description" class="hint">Description</p>
        </div>
        <label class="switch">
          <input type="checkbox" data-field="input" />
          <span class="slider" aria-hidden="true"></span>
        </label>
      </li>
    </template>

    <script src="assets/app.js"></script>
  </body>
</html>
